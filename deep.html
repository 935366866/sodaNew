<!DOCTYPE html>
<html>
<head>
	<title>查看任务</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="content-type" content="text/html" ; charset="utf-8">
	<link href="public/css/reset.css" rel="stylesheet" />
	<link href="public/css/bootstrap.min.css" rel="stylesheet">
	<link href="public/css/bootstrap-table.css" rel="stylesheet">
	<link href="public/css/bootstrap-select.css" rel="stylesheet">
	<link href="public/css/jquery.fileupload.css" rel="stylesheet"> 
	<link href="public/css/jquery-ui-1.9.2.custom.css" rel="stylesheet" type="text/css" media="screen"  />
	<link href="public/css/long_common.css" rel="stylesheet"  media="all">

	<!--弹出层样式-->
	<link href="public/css/jquery.fancybox.css" rel="stylesheet"/>
	<link href="css/deepExcavation.css" rel="stylesheet" >
	<link href="css/soda_common.css" rel="stylesheet" >
			<!--轮播样式-->
	<link href="public/css/style-demo.css" rel="stylesheet" />
</head>

<body>
	<!--前台公共头部-->
	<div class="top">
		<div class="main_nav1">
			<div class="container">
				<a href="#" class="logo"><img src="public/image/navLogo.svg"/></a>
				<ul class="main_nav1_left">
					<li id="main"><a href="main.html">首页</a></li>
					<li id="sodaIndex"><a href="sodaIndex.html">云中漫步</a></li>
					<li id="frontierResearch"><a href="frontierResearch.html" >前沿方案</a></li>
					<li id="marketActive"><a href="marketActive.html">市场活动</a></li>	
				</ul>
				<div class="form-group searchNews" id="search_news">
					<span class="col-sm-2 control-label"><img src="public/image/navSearch.svg"/></span>
					<div class="col-sm-10">
						<input type="text" class="form-control" id="search_news_input">
					</div>
				</div>
				<ul class="main_nav1_right">
					<li id="searchIcon"><a href="#"><img src="public/image/navSearch.svg" alt="搜索" /></a></li>
					<li><a href="#"><img src="public/image/navEmail.svg" alt="通知" /></a></li>
					<li><a href="personalCenter.html"><img src="public/image/navUser.svg" alt="用户" /></a></li>
				</ul>
			</div>
		</div>
		<div class="main_nav2">
			<div class="container">
				<ul class="main_nav2_left">
					<li class="nav2_list1" style="width: 90px;">
						<a href="#" class="active">流程方案<img src="public/image/navDown.svg" alt=""></a>
						<ul class="">
							<li><a href="">DNA流程方案</a></li>
							<li><a href="">RNA流程方案</a></li>
							<li><a href="">医学流程方案</a></li>
						</ul>				
					</li>
					<li class="nav2_list2" style="width: 73px;">
						<a href="#">小工具<img src="public/image/navDown.svg" alt=""></a>
						<ul class="">
							<li><a href="">基本绘图</a></li>
							<li><a href="">流程绘图</a></li>
							<li><a href="">高级绘图</a></li>
							<li><a href="">表格处理</a></li>
							<li><a href="">计算统计</a></li>
						</ul>
					</li>
					<li class=""><a href="myProject.html">我的项目</a></li>
					<li class=""><a href="#">我的目录</a></li>
					<li class=""><a href="recycle.html">回收站</a></li>
				</ul>
				<div class="form-group">
					<div class="col-sm-10">
						<input type="text" class="form-control" placeholder="搜索想要使用的流程或小工具" id="search_flowapp">
					</div>
					<button class="col-sm-2 btn btn_blue" id="search_button">搜索</button>				
				</div>
			</div>
		</div>	
	<div class="nav_line"></div>
		<div class="main_nav3" style="box-shadow:-2px 3px 9px 0px #ccc;">
			<div class="container">
				<ul class="main_nav3_right_report">
					<li  class="report_success"><span id="taskStatus"  class="btn btn-primary"><a href="#">任务运行中</a></span></li>
	
								<!--<li class="report_running"><span><a href="#">任务运行中</a></span></li>
								<li class="report_end"><span><a href="#">任务已终止</a></span></li>
							-->
					<li id="refresh">
						<a href="#"><img src="img/refresh.svg" alt="刷新" /></a>
					</li>
					<li id="stop">
						<a href="#"><img src="img/stop.svg" alt="停止" /></a>
					</li>
					<li id="delete">
						<a href="#"><img src="img/delete.svg" alt="删除" /></a>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<!--/前台公共头部-->
	 <div class="center_box" style="float:left;width:100%;margin-top: 145px;">   
        <!--差异基因筛选-->
        <div id="diffGeneFilter" class="tab-pane active tabContent" style="padding-top: 0;width: 100%;"> 
	        <div class="myTab"  style="margin-bottom: 20px;background: #fff;">
	        	<div style="width: 1200px;margin: 0 auto;height: 100%;">
					<div class="tabs" style="margin-left: 10px;text-align: left;line-height: 88px;font-size: 15px;color: #656565;">
						差异基因筛选参数设置
					</div>	
					<div class="tabs" style="margin-left: 20px;">
						<ul class="nav" id="appTabRight">
							<li><a href="#dgfGeneList" data-toggle="tab">差异基因列表</a></li>
							<li><a href="#dgfShow" data-toggle="tab">火山图</a></li>
							<li><a href="#dgfStatus" data-toggle="tab">任务状态</a></li>
							<li class="active" ><a href="#dgfDirection" data-toggle="tab">使用说明</a></li>	
						</ul>
					</div>	
				</div>	
			</div>
			<div style="width: 1185px;">
				<div class="tab-content input_l">
					<div class="tab-pane in active">		
						<div class="panel  panel-default">				
							<div class="panel-body" style="height: 439px;">
								<form class="parameter" id="dgfParameter">
									<!--输入文件-->
									<div class="part">
										<div class="input_a_l titleNameLeft">输入文件:</div>
										<div class="input_a_m inputLeft" style="width: 345px;">
											<input type="text" class="form-control" id="input" name="input" placeholder="">
										</div>
										<div class="input_a_r">
											<a onclick="openUrl('#input','file')">
												<span class="glyphicon glyphicon-folder-open" style="font-size:20px; top: 5px; cursor:pointer;"></span>
											</a>
											<span class="fileinput-button btn " style="padding: 0 10px;" >
												<img src="public/draw/imgs/app_02.png" alt=""  style="width: 29px;">
												<!--<input id="upload_input" name="upload_input" onclick="upload(this)" type="file">-->
												<input id="upload_input" name="file" onclick="uploadFile('json/uploadTable.json','upload_input','#input')" type="file">
											</span>
										</div>
									</div>
									<!--输出目录-->
									<div class="part">
										<div class="input_a_l titleNameLeft">输出目录:</div>
										<div class="input_a_m" style="width: 345px;">
											<input v-model="dgfInput" type="text" class="form-control" id="dgfInput" name="dgfInput" placeholder="">
										</div>
										<div class="input_a_r">
											<a onclick="opendir_path('dgfInput')">
												<span class="glyphicon glyphicon-folder-open" style="font-size:20px; top: 5px; cursor:pointer;color:#7f8080;"></span>
											</a>	
										</div>
									</div>	
									<div class="line"></div>
									<div class="part">
										<div class="input_a_l titleNameLeft">筛选软件:</div>
										<div class="input_b_3" style="width: 345px;float: left;">
											<select id="filterCondition"  name="filterCondition" class="selectpicker select_width" autocomplete="off" >
												<option value="DESeq2">DESeq2</option>
												<option value="DESeq">DESeq</option>
												<option value="edgeR">edgeR</option>
												<option value="DEGseq">DEGseq</option>
											</select>
										</div>									
									</div>
									<div class="part">
										<div class="input_a_l titleNameLeft">p值类型:</div>
										<div class="input_b_3" style="width: 345px;float: left;">
											<select id="dgfPTypes"  name="dgfPTypes" class="selectpicker select_width" autocomplete="off" >
												<option value="padj">padj</option>
												<option value="pval">pval</option>
											</select>
										</div>									
									</div>
									<div class="part">
										<div class="input_a_l titleNameLeft">p值大小:</div>
										<div class="input_a_m" style="width: 345px;">
											<input v-model="dgfPValue" id="dgfPValue" name="dgfPValue" value="0.05" type="text" class="form-control">
										</div>								
									</div>
									<div class="part">
										<div class="input_a_l titleNameLeft">差异倍数:</div>
										<div class="input_a_m" style="width: 345px;">
											<input v-model="diffMultiple" type="text" class="form-control" id="diffMultiple" name="diffMultiple" value="2.0">
										</div>								
									</div>
									<div class="line"></div>
									<div class="part">
										<div style="float:left;width:22%;margin-left: 20px;height: 34px;line-height: 34px;">
											样本名称：
										</div>
										<div style="float:left;width:20%;margin-right: 20px;">
											<div>
												<button onclick="return false" class="btn btn-default" data-target='#groupModal' data-toggle='modal' style="outline: none;">
													<span class="glyphicon glyphicon-plus">Group</span>
												</button><br />
											</div>
										</div>
										<div style="float:left;width:22%;margin-right: 20px;">
											<div>
												<button onclick="return false" class="btn btn-default" data-target='#compareModal' data-toggle='modal'style="outline: none;">
													<span class="glyphicon glyphicon-plus">Compare</span>
												</button>
											</div>   
										</div>
										<div style="float:left;width:20%;margin-right: 20px;">
											<div>
												<button onclick="return false" class="btn btn-default"  data-target='#vennModal' data-toggle='modal' style="outline: none;">
													<span class="glyphicon glyphicon-plus">Venn</span>
												</button>
											</div>
										</div>
									</div>
									<div class="part">
										<div style="width:100%;">																				
											<div style="float:left;width:22%;margin-right: 20px;">
												<div id="sampleWrap">
													<ol id="sampleNames" class="list-group sampleNames ui-helper-reset ui-helper-clearfix" style="height: 100%;"></ol>
												</div>
											</div>
											<div id='groupList' style="float:left;width:20%;margin-right:20px;"></div>
											<div id='compareList' style="float:left;width:20%;margin-right:20px;"></div>
											<div id='vennList' style="float:left;width:20%"></div>																					
										</div>
									</div>
								</form>
							</div>
							<div class="panel-footer" style="height: 51px;">
								<button id="dgfSubmit_paras" type="button" class="btn btn-success submit">开始运行</button>
							</div>
						</div>
						<!-- group modal -->
						<div class="row">
							<div style="width:100%;">
								<div class="row">
									<div class="modal fade " id="groupModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
										<div class="row">
											<div id='list_model' class="modal-dialog " style='width:20%'>
												<div class="modal-content">
													<div class="modal-header">
														<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
														<h4 class="modal-title" id="myModalLabel">组名</h4>
														<div class="input-group">
															<input id="groupName" class="form-control" value='' />
															<span id='addGroup' class='glyphicon glyphicon-circle-arrow-right input-group-addon'></span>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<!-- /.modal end -->
								</div>
							</div>
						</div>
						<!-- compare modal -->
						<div class="row">
							<div style="width:100%;">
								<div class="row">
									<div class="modal fade " id="compareModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
										<div class="row">
											<div id='list_model' class="modal-dialog " style='width:20%'>
												<div class="modal-content">
													<div class="modal-header">
														<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
														<h4 class="modal-title" id="myModalLabel">组间比较</h4>
														<div class="input-group">
															<input id="compareName" class="form-control" value='' />
															<span id='addCompare' class='glyphicon glyphicon-circle-arrow-right input-group-addon'></span>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<!-- /.modal end -->
								</div>
							</div>
						</div>
						<!-- venn modal -->
						<div class="row">
							<div style="width:100%;">
								<div class="row">
									<div class="modal fade " id="vennModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
										<div class="row">
											<div id='list_model' class="modal-dialog " style='width:20%'>
												<div class="modal-content">
													<div class="modal-header">
														<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
														<h4 class="modal-title" id="myModalLabel">维恩组</h4>
														<div class="input-group">
															<input id="vennName" class="form-control" value='' />
															<span id='addVenn' class='glyphicon glyphicon-circle-arrow-right input-group-addon'></span>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<!-- /.modal end -->
								</div>
							</div>
						</div>
					</div>
				</div>
		
				<div class="tab-content input_r">
					<!-- 使用说明 -->
					<div class="tab-pane in active" id="dgfDirection">
						<div class="panel panel-default">
							<div class="panel-body">
								<p style="font-weight: bolder;">描述：</p>
								<p class="indent">
								调整差异分析参数，使用项目计算的定量数据，重新进行差异分析。
								</p>
								<p>参数填写：</p>
								<p class="indent">
									<p class="indent">1、选择输出目录</p>
									<p class="indent">计算过程文件和最终结果文件存放的根目录，建议与项目目录不同。若与项目目录相同，则会覆盖之前项目中差异分析的结果文件。</p>
								</p>
								<p class="indent">
									<p class="indent">2、选择比较差异基因的工具</p>
									<p class="indent">筛选软件：比较差异基因的工具。可选工具包括DESeq2、DESeq、edgeR和DEGSeq，默认使用DESeq2。DEGSeq用于无生物学重复的分析。</p>
								</p>
								<p class="indent">
									<p class="indent">3、设置差异基因筛选阈值</p>
									<p class="indent">p值类型：筛选差异基因时使用的p值类型。可选p值类型有pval和padj。pval是原始的富集p值，而padj则为校正后的p值。默认使用padj。</p>
									<p class="indent">p值大小：筛选差异基因时使用的p值大小，默认为0.05。</p>
									<p class="indent">差异倍数：筛选差异基因时使用的差异倍数（fold change），默认为2。</p>
								</p>
								<p class="indent">
									<p class="indent">4、设置分组信息</p>
									<p class="indent">根据需要调整分组和比较信息，默认按照原项目设置的分组信息进行后续分析。</p>
								</p>
								<p>任务提交：</p>
								<p class="indent">
									在设置完所有参数后，点击run按钮，计算任务会在服务器上运行。
								</p>
								<p>结果查看：</p>
								<p class="indent">
									右侧任务状态选项卡可以查看计算任务的状态。在任务计算完成后，可以从右侧选项卡中查看主要结果文件。在差异基因列表选项卡中，通过下拉框中选择比较组名，查看对应差异基因列表；在火山图选项卡中，通过点击左右按钮，滚动图片，查看各比较组的火山图。同样也可以在输出目录中找到结果文件，下载查看。
								</p>
							</div>
						</div>
					</div>
					
					<!-- 任务状态 -->
					<div class="tab-pane" id="dgfStatus">
						<div class="panel panel-default">
							<div class="panel-body">
								<table data-toggle="table"  data-show-footer="false" data-sort-name="id" id="dgfmodStatusTable">
									<thead>
										<tr>
											<th data-field="flow_mod" data-sortable="true">模块名称</th>
											<th data-field="task_name" data-sortable="true">程序名称</th>
											<th data-field="status" data-sortable="true" data-align="center" data-formatter="taskState">状态</th>
											<th data-field="submit_time" data-sortable="true" data-align="center">任务提交时间</th>
											<th data-field="done_time" data-sortable="true" data-align="center">任务结束时间</th>
											<th data-field="consume_time" data-sortable="true" data-align="center">时长</th>
										</tr>
									</thead>
								</table>
							</div>
						</div>
					</div>
					<!-- 基因列表 -->
					<div class="tab-pane" id="dgfGeneList">
						<div class="panel panel-default">
							<div class="panel-body">
								<div style="margin-bottom: 50px;">
									<div style="display: inline-block;width: 60px;float: left;height: 34px;line-height: 34px;">比较组：</div>
									<div class="input_b_3" style="width: 260px;float: left;">
										<select  id="compareGroups"  name="compareGroups" class="selectpicker select_width" autocomplete="off">
										</select>
									</div>		
								</div>
								<table ></table>
							</div>
						</div>
					</div>
					<!-- 绘图展示 -->
					<div class="tab-pane" id="dgfShow">
						<div class="panel panel-default">
							<div class="panel-body">
								<div class="jcl-demo" style="width: 500px;height: 460px;">
								    <div class="custom-container default">
								        <a href="#" id="dgfPrev" class="prev">&lsaquo;</a>
								        <div id="dgfCarousel" class="carousel" style="width: 455px;height: 460px;">
								            <ul>
								            	<li style="width: 455px;height: 460px;" id="li1"><a class="fancybox-effects-a" href="" title="Lorem"><img style="width: 455px;height:460px;padding-right: 23px;" src="" alt="" /></a></li>
								            	<li style="width: 455px;height: 460px;" id="li2"><a class="fancybox-effects-a" href="" title="Lorem"><img style="width: 455px;height:460px;padding-right: 23px;" src="" alt="" /></a></li>
								            	<li style="width: 455px;height: 460px;" id="li3"><a class="fancybox-effects-a" href="" title="Lorem"><img style="width: 455px;height:460px;padding-right: 23px;" src="" alt="" /></a></li>
								            </ul>
								        </div>
								        <a href="#" id="dgfNext" class="next">&rsaquo;</a>
								        <div class="clear"></div>
								    </div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	
	
	<!-- 添加选择目录的模态框 -->
	<div class="modal fade" id="selectUrl" tabindex="-1" aria-labelledby="选择路径" aria-hidden="true">

		<div class="modal-dialog" style="top:50px; width:800px;">
			<div class="modal-content ">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
						&times;
					</button>
					<h4 class="modal-title">路径</h4>
					<div class="input-group">
						<input type="text" class="form-control" id="inputUrl">
						<span class="input-group-btn">
							<button class="btn btn-default glyphicon glyphicon-arrow-left" id="back" type="button" style="top: 0px;"></button>
							<button class="btn btn-default glyphicon glyphicon-arrow-right" id="search" type="button" style="top: 0px;"></button>
						</span>
					</div>
				</div>
				<!-- -----------------------------------------------------------data-single-select="true"------------------------ -->
				<div class="modal-body" style="text-align:center; ">
					<table data-toggle="table" data-url="json/jobUrl.json" data-minimum-count-columns="2" data-id-field="id" data-show-footer="false"
						data-height="300" data-sort-name="id" data-click-to-select="true" id="jobUrlTable"
						style="bottom:20px;">

						<thead>
							<tr>
								<th data-field="state" data-checkbox="true"></th>
								<th data-field="icon" data-formatter="addIcon"></th>
								<th data-field="name" data-align="left" data-sortable="true">name</th>
								<th data-field="type" data-align="center" data-sortable="true">attribute</th>
								<th data-field="inodeNum" data-align="center" data-visible="false" data-sortable="true">inodeNum</th>
								<th data-field="size" data-align="center" data-sortable="true">size</th>
								<th data-field="owner" data-align="center" data-sortable="true">owner</th>
								<th data-field="group" data-align="center">group</th>
								<th data-field="mtime" data-align="center" data-sortable="true">time</th>
							</tr>
						</thead>
					</table>
				</div>
				<!-- ----------------------------------------------------------------------------------- -->
				<div class="modal-footer">
					<button type="button" id="selected" class="btn btn-primary">
					选择
					</button>
					<button type="button" id="cancel" class="btn btn-default" data-dismiss="modal">
					关闭
					</button>

				</div>
			</div>
		</div>
	</div>

	<div id="footer_style">
		<footer class="footerstyle">
			<p>版权所有 © 2016 京ICP备15033925号</p>
			<p>北京拓美科基因科技有限公司</p>
		</footer>
	</div>
	<script src="public/js/jquery-1.9.1.min.js"></script>
	<script src="public/js/bootstrap.min.js"></script>
	<script src="public/js/bootstrap-table.js"></script>
	<script src="public/js/bootstrap-select.js"></script>
	<script src="public/js/jquery.ui.widget.js"></script>
	<script src="public/js/jquery.fileupload.js"></script>
	<script src="public/js/jquery.iframe-transport.js"></script>
	<script src="public/js/jquery-ui-1.9.2.custom.min.js" type="text/javascript"></script>
	<script src="public/js/jquery.blockUI.js" type="text/javascript"></script>
	<!--轮播图片插件-->
	<script src="public/js/jquery.mousewheel-3.1.12.js"></script>
	<script src="public/js/jquery.jcarousellite.js"></script>
	<!--FancyBox弹出窗口插件-->
	<script src="public/js/jquery.mousewheel.pack.js"></script>
	<script src="public/js/jquery.fancybox.pack.js"></script>

	<script src="public/js/long_common.js"></script>
	<script src="js/go.js"></script>
	<script src="js/common1.js"></script>	
	<script>	
	$(document).ready(function() {
		$(".fancybox-effects-a").fancybox({
			width:500,
			height:500,
			helpers: {
				title : {
					type : 'outside'
				},
				overlay : {
					speedOut : 0
				}
			}
		});

	});
		
//------按钮们--------
//刷新
	$("#refresh").click(function(){
		window.location.reload();
    });
//终止
	$("#stop").click(function(){
		var r=confirm("您确定要终止该任务吗？");
		if(r==true){
			 var id = $("#taskId").val();
			 $.ajax({
				    url:stop_url,  
				    type:'post',
				    data:{id:id},
				    dataType: "json",
				    success:function(data) {
				    	if(data['status']=='ERROR'){    //请求成功但没有执行成功
				    		alert(data['data']);
				    	}else{
							alert("任务终止成功！");	
							$(this).find("img").attr("src","img/start.svg") 
				    	};
				     },    
				     error : function(XMLHttpRequest) {
				       alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);    
				     }
				});  
		  };
    });    
//删除
	$("#delete").click(function(){
		var r=confirm("您确定要删除该任务吗？");
		if(r==true){

			 var id = $("#taskId").val();
			 $.ajax({
				    url:delete_url,  
				    type:'post',
				    data:{id:id},
				    dataType: "json",
				    success:function(data) {
				    	if(data['status']=='ERROR'){    //请求成功但没有执行成功
				    		alert(data['data']);
				    	}else{
							alert("删除成功！");	
				    	};
				     },    
				     error : function(XMLHttpRequest) {
				       alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);    
				     }
				});  
		  };
    });
/*-----------------差异倍数页面js代码------------------*/
$(function(){
	var compareData = null;
	var geneSet;
	$('a[href="#dgfGeneList"]').on('show.bs.tab', function (e) {
		updateTable("compareGroups","dgfGeneList",compareData);
	})
	
	/*轮播图片初始化*/
    $("#dgfCarousel").jCarouselLite({
        btnNext: ".default #dgfNext",
        btnPrev: ".default #dgfPrev",
        visible: 1,
        speed: 800
    });
    function statusUpdate(){
    	$.ajax({
				url:'json/taskDetail.2.json',  
				type:'get',
				dataType: "json",
				success:function(data) {
					$('#dgfmodStatusTable').bootstrapTable('load',data["modStatus"]);
				},
				error : function(XMLHttpRequest) {
				   alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);    
				}
			})

    }
	/*打开任务状态不断更新数据*/
	var setInt;
	$('a[href="#dgfStatus"]').on('show.bs.tab', function (e) {
		statusUpdate();
		setInt=window.setInterval(statusUpdate,5000)
	})
	/*关闭任务状态不更新数据*/
	$('a[href="#dgfStatus"]').on('hide.bs.tab', function (e) {
		window.clearInterval(setInt)
	})
	
	$("#groupName").keydown(function(k){
		if(k.keyCode==13 ){
			addGroup();
		}
	});
	$("#addGroup").click(function(){
		addGroup();
	});
	$("#compareName").keydown(function(k){
		if(k.keyCode==13 ){
			addCompare();
		}
	});
	$("#addCompare").click(function(){
		addCompare();
	});
	$("#addVenn").click(function(){
		addVenn();
	});
	
	//提交参数
	$("#dgfSubmit_paras").click(function(){
		var formData =  allParams($("#dgfParameter"));//取form表单参数
		if(formData.dgfInput==""){
			alert("请选择输出目录！");
		}else{
			if($("#dgfPValue").val()<0||$("#dgfPValue").val()>1){
				alert("p值大小必须大于等于0小于等于1！")
			}
			if($("#diffMultiple").val()<0){
				alert("差异倍数必须大于等于0！")
			}
			var groupCompareVenn={};	
			
			var groups =$('#groupList').find('div');
			var allGroupItems=[];
			if(groups.length>0){
				var groupSamples= {};
				for(var i=0; i<groups.length; i++){
					var sampleItems = $($(groups[i]).find('ul')[0]).find('li');
					if(sampleItems.length==0){
						continue;
					}			
					//组名
					var curGroup =$($(groups[i]).find('span')).text().replace(/(^\s*)|(\s*$)/g, "");  //空格开头或者结尾
					var curGroupSamples = new Array();
					for(var j=0; j < sampleItems.length ;j++){
						curGroupSamples.push($(sampleItems[j]).text().replace(/(^\s*)|(\s*$)/g, ""));
					}
					allGroupItems.push(curGroupSamples[0]);
					groupSamples[curGroup]= curGroupSamples;
				}
				groupCompareVenn['groupSamples']= groupSamples;
			}
		//检查数据
		//检查样本是否已全部分组，非强制
		var samples=$("#sampleNames").find('li');
		if(samples.length>0){
			for(var i=0;i<samples.length;i++){
				if(allGroupItems.indexOf(samples[i].innerText)==-1){
					if(!confirm("发现有未分组的样品，确定不分组?")){
						return false;
					}
				}
			}
		}

		//全部的参数	
		var samplesStr=""
		for(var j=0;j<samples.length;j++ ){  
			if(samplesStr == ""){
				samplesStr += samples[j].innerText;
				}
			else{
				samplesStr += ","+samples[j].innerText;
				}
		};

		var resultPara={
						"id":dirId,
						"paras":formData,
						"samples":samplesStr,
						"groupCompareVenn":groupCompareVenn
						}; 
						
		resultPara = JSON.stringify(resultPara);
			$.ajax({
				url: 'json/taskDetail.2.json',  
				type:'get',
				data:{parameter:resultPara},
				dataType: "json",
				success:function(data) {	
					var showData=data["show"];
					compareData=data["arr"];
					$("#dgfCarousel").empty();
					$("#dgfCarousel").append("<ul></ul>");
 					for(var i=0;i<showData.length;i++){
 						$("#dgfCarousel").find("ul").append("<li style='width: 455px;height: 460px;' ><a class='fancybox-effects-a' href='"+showData[i]+"' title='Lorem'><img style='width: 455px;height:460px;padding-right: 23px;' src='" + showData[i] +"' alt='' /></a></li>")
 					}
     				$("#dgfCarousel").jCarouselLite({
				        btnNext: ".default #dgfNext",
				        btnPrev: ".default #dgfPrev",
				        visible: 1,
				        speed: 800
				    });
					for(var i=0;i<compareData.length;i++){
						var option="<option value="+compareData[i]["compareName"]+">"+compareData[i]["compareName"]+"</option>"
						$("#compareGroups").append(option);
					}
					$('#compareGroups').selectpicker('refresh');
					$('#compareGroups').on('changed.bs.select', function (e) {
						updateTable("compareGroups","dgfGeneList",compareData);
					});					
							
				},    
				error : function(XMLHttpRequest) {
					alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);
				}
			});
		}
	});
});

//初始化拖拽
function dragInit() {
	var $sampleNames = $( "#sampleNames" ),
    		$sampleGroup = $( ".sampleGroup" ),
    		$compareGroup = $(".goupCompare")
    		$venn = $(".venn");
	//样本拖动
	$( "li", $sampleNames ).draggable({
	      cancel: "a.ui-icon", // 点击一个图标不会启动拖拽
	      revert: "invalid", // 当未被放置时，条目会还原回它的初始位置
	      containment: "document",
	      helper: "clone",
	      cursor: "move"
	    });
	//分组拖动
	$( ".sampleGroup" ).draggable({
	    revert: "invalid", 
	    containment: "document",
	    helper: "clone",
	    cursor: "move"
	});
	
	//比较组拖动
	$(".goupCompare").draggable({
	      revert: "invalid", 
	      containment: "document",
	      helper: "clone",
	      cursor: "move"
	    });
	//维恩图接收比较组名
	$venn.droppable({
	      accept: "#compareList>div",
	      activeClass: "ui-state-highlight",
	      tolerance:"pointer",
	      drop: function( event, ui ) {
	        dropItem( ui.draggable ,$(this),'#333', 5);
	      }
	    });
	//比较组接收组名
	$compareGroup.droppable({
	      accept: ".sampleGroup",
	      activeClass: "ui-state-highlight",
	      tolerance:"pointer",
	      drop: function( event, ui ) {
	        dropItem( ui.draggable ,$(this),'#333',2);
	      }
	    });
	//分组接收样本
	var maxNum=$("#sampleNames li").length
	$sampleGroup.droppable({
	      accept: "#sampleNames > li, .sampleGroup li",
	      activeClass: "ui-state-highlight",
	      tolerance:"pointer",
	      drop: function( event, ui ) {
	        dropItem( ui.draggable ,$(this),'#333',maxNum);
	      }
	    });
	 if(maxNum>12){
	 	$("#sampleNames").css({
	 		height:'360px',
	 		overflow:'auto'
	 	})
	 }
	if($("#groupList .sampleGroup").length>12){
		$("#groupList").css({
	 		height:'360px',
	 		overflow:'auto'
	 	})
	}

	    curcontainer= null;
	    function dropItem($item ,$container,$color,maxNum){
	    	if($item.context.localName=='li'){
	    		var itemName = $item.text();
	    		var items = $container.find('li');
		    	if(items.length>=maxNum){
		    		alert("超出了最大允许数目"+maxNum);
		    		return false;
		    	}
		    	for (var i=0; i<items.length; i++){
		    		if($(items[i]).text()==itemName){
		    			alert("有重复的条目"+itemName+"！");
		    			return false;
		    		}
		    	}
	    		var $list = $( "ul", $container ).length ?$( "ul", $container ) :$( "<ul class='sampleNames ui-helper-reset'/>" ).appendTo($container);
			    $('<li class="list-group-item ui-widget-content ui-corner-tr ui-draggable" style="display: block;border:none;background:none; width: 90px;color:'+$color+'">'
		    	+itemName+'</li>').appendTo($list).fadeIn(function() {
		  	            $item
			              	.find( "img" )
			                .animate({ height: "36px" });
			          	});
			        
	    	}else{
	    		var itemName = $item.children("span").text();
		    	//遍历container查看已包含哪些元素
		    	var containItems= new Array();
		    	var items = $container.find('li');
		    	if(items.length>=maxNum){
		    		alert("超出了最大允许数目"+maxNum);
		    		return false;
		    	}
		    	for (var i=0; i<items.length; i++){
		    		if($(items[i]).text()==itemName){
		    			alert("有重复的条目"+itemName+"！");
		    			return false;
		    		}
		    	}
		    	
		    	var $list = $( "ul", $container ).length ?
			            $( "ul", $container ) :
			            $( "<ul class='goupCompare ui-helper-reset'/>" ).appendTo($container);
			    $('<li class="list-group-item ui-widget-content ui-corner-tr ui-draggable" style="display: block;border:none;background:none; width: 90px;color:'+$color+'">'
			    	+itemName+'</li>').appendTo($list).fadeIn(function() {
			            $item
			              .find( "img" )
			                .animate({ height: "36px" });
			         });
		    		
	    	}
	    }
	    
	    function recycleItem( $item ) {
	      $item.fadeOut(function() {
	        $item
	          .find( "a.ui-icon-refresh" )
	            .remove()
	          .end()
	          .css("background-color","#FFFFFF").css("border","1px solid #dddddd")
	          .find( "img" )
	            .css( "height", "72px" )
	          .end()
	          .appendTo( $sampleNames )
	          .fadeIn();
	      });
	    }
	    
	    $("#groupList .glyphicon-remove").each(function(){
			$(this).click(function(){
				$(this).parent('div').remove();
				var value=$(this).siblings("span").text();
				var index=$.inArray(value,allgroups);
				
				if(index==-1){
					return ;
				}
				allgroups.splice(index,1);
				
				$("#compareList").find("li").each(function(){
					if($(this).text()==value){
						$(this).remove();
					}
					
				})

				dragInit();
			})
		});
		$("#compareList .glyphicon-remove").each(function(){
			$(this).click(function(){
				$(this).parent('div').remove();
				var value=$(this).siblings("span").text();
				var index=$.inArray(value,allCompares);
				if(index==-1){
					return ;
				}
				
				$("#vennList").find("li").each(function(){
					if($(this).text()==value){
						$(this).remove();
					}
					
				})
				allCompares.splice(index,1);
			})
		});
		$("#vennList .glyphicon-remove").each(function(){
			$(this).click(function(){
				var value=$(this).siblings("span").text();
				var index=$.inArray(value,allVenns);
				if(index==-1){
					return ;
				}
				allVenns.splice(index,1);
				$(this).parent('div').remove();
			})
		});
};

var patrn=/^(\w){1,10}$/i; 
var allgroups = new Array();	//all groups
function addGroup(){
	var gname= $("#groupName").val();
	if(gname=='' ||gname==null){
		return false;
	}
    if (!patrn.exec(gname)) {
    	alert('只能包含字母数字下划线，长度不超过10');
		return false;
	}
	if(-1!=allgroups.indexOf(gname,0)){
		alert('分组名'+gname+"已存在！");
		return false;
	}
	if($('#sampleNames>li').length<=allgroups.length){
		alert("分组数不能超过样本数！");
		return false;
	}
	$("#groupName").val('');
	var html='<div name="sampleGroup" class="ui-widget-content ui-state-default sampleGroup" style=border-radius:3px;><span class="ui-widget-header" style=font-size:18px;height:28px;border:none;background:none;display:inline-block;>'+gname+'</span><button style=opacity:.2; class="ui-widget-header glyphicon glyphicon-remove pull-right closeBorder" ></button></div>';
	$(html).appendTo('#groupList');
	allgroups.push(gname);
	dragInit();
}

//增加比较组
var allCompares = new Array(); 
function addCompare(){
	if(allgroups.length <2){
		alert('此为组间比较，至少需要两个样本组，请先填写样本组信息！');
		return false;
	}

	var cname= $('#compareName').val();
	if (!patrn.exec(cname)) {
    	alert('只能包含字母数字下划线，长度不超过10');
		return false;
	}
	if(cname=='' ||cname==null){
		return false;
	}
	if(-1!=allCompares.indexOf(cname,0)){
		alert('比较组'+cname+"已存在！");
		return false;
	}
	$('#compareName').val('');
	var html='<div name="goupCompare" class="ui-widget-content ui-state-default goupCompare" style=border-radius:3px;><span class="ui-widget-header" style="font-size:18px;border:none;background:none;height:28px;display:inline-block;" >'+cname+'</span><button style=opacity:.2; class="ui-widget-header glyphicon glyphicon-remove pull-right closeBorder" ></button></div>';
	$(html).appendTo('#compareList');
	allCompares.push(cname);
	dragInit();
}
var allVenns = new Array(); 
function addVenn(){
	if(allCompares.length <2){
		alert("维恩图至少需要两个比较组，请先填写比较组信息！");
		return false;
	}
	var cname= $('#vennName').val();
	if (!patrn.exec(cname)) {
    	alert('只能包含字母数字下划线，长度不超过10');
		return false;
	}
	if(cname=='' ||cname==null){
		return false;
	}
	if(-1!=allVenns.indexOf(cname,0)){
		alert('维恩组'+cname+"已存在！");
		return false;
	}
	$('#vennName').val('');
	var html='<div name="venn" class="ui-widget-content ui-state-default venn" style=margin-left:10px;border-radius:3px;><span class="ui-widget-header" style="font-size:18px;border:none;background:none;height:28px;display:inline-block;" >'+cname+'</span><button style=opacity:.2; class="ui-widget-header glyphicon glyphicon-remove pull-right closeBorder" ></button></div>';

	$(html).appendTo('#vennList');
	allVenns.push(cname);
	dragInit();
}

/*-------------公共函数-------------------*/
function updateTable(selectId,tabPanelId,compareData){
		if(!compareData) return;
		var p=$("#"+selectId).selectpicker("val");
		for(var j=0;j<compareData.length;j++){
			if(p==compareData[j]["compareName"]){
				var content=compareData[j]['content'];
				var head=content[0];
				var options={
					clickToSelect:true,
					showFooter:false,
					classes:'table',
					columns: []
				}
				for(var m=0;m<head.length;m++){
					var obj={order: "asc"};
					obj["title"]=head[m];
					obj["field"]=head[m];
					options.columns.push(obj);
				}
				$("#"+tabPanelId+" table").bootstrapTable(options);
				var tableData=[];
				for(var i=1;i<content.length;i++){
					var row=content[i];
					var rowObj={};
					for(var k=0;k<row.length;k++){
						rowObj[head[k]]=row[k];
					}
					tableData.push(rowObj);
				}
				$("#"+tabPanelId+" table").bootstrapTable('destroy');
				$("#"+tabPanelId+" table").bootstrapTable(options);
				$("#"+tabPanelId+" table").bootstrapTable('load',tableData);
			}
		}
	}
//任务的状态
function taskState(State) {
	
    if ( State == 'done'){
			return  '<button class="btn btn-primary btn-xs" style="width:100px;">完成</button>';
		}else	if ( State == 'failed'){
			return '<button class="btn btn-warning btn-xs" style="width:100px;">中止</button>';
		}else if (State == 'ready'){
			return '<button class="btn  btn-xs" style="width:100px;">就绪/重运行</button>';
		}else if (State == 'pending'){
			return '<button class="btn btn-xs" style="width:100px;">等待中</button>';
		}
		else{
			return '<button class="btn btn-success btn-xs" style="width:100px;">运行中</button>';
		}
};	
	
//参数组装
function allParams(dom){
	var app = dom.serializeArray();
	var json1 = {};
	for(var i=0;i<app.length;i++){
			var name = app[i].name;
			var value = app[i].value;
			json1[name] = value;
	}
	return json1;
};

//-----------------------------------点击打开目录--------------------------------------------	
var samplesDataUrl = "json/jobUrl.json"; //像后台发送目录的地址
//打开任务目录
function opendir_path(id){
	var inputValue = $("#"+id).val();  //当前input的值
	$("#inputUrl").val(inputValue);
	$('#selectUrl').modal('show');
    $("#selected").attr("onClick","geturl('#"+id+"','dir')")
};
//打开任务目录
function openUrl(id,type){
	var inputValue = $(id).val();  //当前input的值

	$("#inputUrl").val(inputValue);
	$('#selectUrl').modal('show');

    $("#selected").attr("onClick","geturl('"+id+"','"+type+"')")   //给选择按钮添加事件

};

//选择目录时添加文件或者目录的图标
function addIcon(State, row) {
	var typeChr = row.type.charAt(0);
		
	if(typeChr == 'd'){
		return '<span class="glyphicon glyphicon-folder-open"></span>';
		}
	else{
		return '<span class="glyphicon glyphicon-file"></span> ';
		}
};
//当模态框加载完成后给input中添加当前用户的根目录
$(function(){
  dblCilck('jobUrlTable','inputUrl',samplesDataUrl);
  $('#selectUrl').on('shown.bs.modal', function () {    //模态框完全显示之后把根目录放入
//	      	$("#inputUrl").val("/home/agloom");
  	if($("#inputUrl").val()==''){
  		$("#inputUrl").val('/');
  	}
  	checkUrl($("#inputUrl").val(), samplesDataUrl, 'inputUrl','jobUrlTable');
  });
});


//回车查目录是否存在
$(function(){
	$('#inputUrl').bind('keypress',function(event){
		if(event.keyCode == "13")    
		{
			newUrl = $("#inputUrl").val();
			checkUrl(newUrl,samplesDataUrl,"inputUrl","jobUrlTable"); //参数依次为需要检查的URL， 后台的地址， 需要更新的输入框id， 需要刷新的bootstrap table
		}
	});
//点击右边箭头，检查	
	$("#search").click(function(){  
    	  newUrl = $("#inputUrl").val();
		  checkUrl(newUrl,samplesDataUrl,"inputUrl","jobUrlTable");
    });  
//后退按钮
	$("#back").click(function(){  
    	   Url= $("#inputUrl").val();
		   
		   lastLen =Url.split('/').pop().length
		   newUrl = Url.substring(0,Url.length - lastLen-1);
		   checkUrl(newUrl,samplesDataUrl,"inputUrl","jobUrlTable");
    }); 
	
});
var samplesArr=[];
function uploadFile(url,uploadId,inputId,ddir){  
		dpath = '';
		if(typeof(ddir)!='undefined'|| ddir=='undefined' ||ddir==''){
			dpath = ddir;
		}
	    $('#'+uploadId).fileupload({
	        url: url,
	        dataType: 'json',
	        done: function (e, data) {   //设置文件上传完毕事件的回调函数  
				var status = data.status;
				if(status == "ERROR"){
					alert(data.data);
					}
				else{
					var url = data.data.url;
					$(inputId).val(url);    
					samplesArr = data.data.samples;
					alert("上传成功！");
					}
	        }
	    })
};	

//点击选择关闭模态框，将当前模态框input中的路径取出放入表单中,type 的类型 暂时有两种，dir和 file
function geturl(formInputId,type){
	var selected_num = checkedNum("jobUrlTable");
	if(type == "dir"){
		//只能选择文件夹，单选
		var newUrl = ""
		
		if(selected_num == 1){
			//此时选中了一项，判断是否是目录
			
			var singleName = ""   //选择一个文件夹或者文件的名字，单选
			$.map($('#jobUrlTable').bootstrapTable('getSelections'), function (row) {
				var d_f_type = "";
				d_f_type = row.type.charAt(0);
				if(d_f_type == "d"){
					singleName = row.name;
					newUrl = $("#inputUrl").val() + "/"+ singleName;    //点击选择时取input中当前的路径，在加上此时选择的
					newUrl = newUrl.replace('//','/');
					$("#selected").removeAttr("onClick");   //选择按钮
					$("#selectUrl").modal('hide');          //隐藏目录选择的模态框
					$(formInputId).val(newUrl);	
					if(formInputId == "#data_dir"){
						var sequencingType = $("#seq_type").val();
						$.ajax({
								url:samplesDataUrl,  
								type:'get',
								data:{url:newUrl},
								dataType: "json",
								success:function(data,textStatus) {
									if(data['status']=='ERROR'){    //请求成功但没有执行成功
										alert(data['data']);
									}else{
										var data1 = data['data'];

										objData = dataTableGet(data1,sequencingType);   //向后台传输数据，返回值组成Json
										
										$('#sampleTable').bootstrapTable('load',objData);  //填入table中	
									}
								},    
								error : function(XMLHttpRequest) {
									alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);   
								}
						}); 
					
					};
				}else{
					alert("对不起，您选择的必须是目录文件！");
				
				};
						
			});
			
		
		}else if(selected_num == 0){
			//没有选中任何项，将此时的url传到前面

			newUrl = $("#inputUrl").val();    //点击选择时取input中当前的路径，在加上此时选择的
			newUrl = newUrl.replace('//','/');
			$("#selected").removeAttr("onClick");
			$("#selectUrl").modal('hide');
			$(formInputId).val(newUrl);

			var sequencingType = $("#seq_type").val();
			$.ajax({
					url:samplesDataUrl,  
					type:'get',
					data:{url:newUrl},
					dataType: "json",
					success:function(data,textStatus) {
						if(data['status']=='ERROR'){    //请求成功但没有执行成功
							alert(data['data']);
						}else{
							var data1 = data['data'];
							objData = dataTableGet(data1,sequencingType);   //向后台传输数据，返回值组成Json
							console.log(objData)
							$('#sampleTable').bootstrapTable('load',objData);  //填入table中
						}
					},    
					error : function(XMLHttpRequest) {
						alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);   
					}
			}); 
		}
		else{
			//选择了多项，直接报错
			alert("对不起，只能选择一个目录文件！");
		};
		
	}
	else if(type == "file"){
		//只能选择文件，多选
		var newUrl = ""
		var files = [];
		var have_dir = 0
		$.map($('#jobUrlTable').bootstrapTable('getSelections'), function (row) {
			var d_f_type = "";
			d_f_type = row.type.charAt(0);
			if(d_f_type == "d"){
				have_dir = 1;
			}else{
				files.push(row.name);
			}
			
		});
		if(have_dir == 1){
			alert("对不起，不能选择文件夹，只能选择文件！");
		}else{
			if(files.length == 0){
				alert("请选择文件！")
			}else{
				//获得当前的目录，取消绑定，关闭模态框
				var filename_now = '/'+ $('#jobUrlTable').bootstrapTable('getSelections')[0].name;
				newUrl = $("#inputUrl").val()+filename_now;
				newUrl = newUrl.replace('//','/');	
				$.ajax({
						url:"json/uploadTable.json",  
						type:'get',
						data:{url:newUrl},
						dataType: "json",
						success:function(data,textStatus) {
							if(data['status']=='ERROR'){    //请求成功但没有执行成功
								alert(data['data']);
							}else{
								var data1 = data['data'];
								var samples=data1["samples"];
								samplesArr=samples;
								//样本分组初始化设置
								if(samplesArr.length>0){
									for(var i=0;i<samplesArr.length;i++){
										var name = samplesArr[i];
										add='<li class="list-group-item ui-widget-content ui-corner-tr">'+name+'</li>'
										$(add).appendTo('#sampleNames')
								
									};	
									dragInit();
								}
							}
						},    
						error : function(XMLHttpRequest) {
							alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);   
						}
				}); 
				
				$("#selected").removeAttr("onClick");
				$("#selectUrl").modal('hide');
				$(formInputId).val(newUrl);				
			};
		};

	}
	else{
		return false;
	}

};

</script>


</body>

</html>