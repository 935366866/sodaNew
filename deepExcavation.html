<!DOCTYPE html>
<html>
<head>
	<title>查看任务</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="content-type" content="text/html" ; charset="utf-8">
	<link href="public/css/reset.css" rel="stylesheet" />
	<link href="public/css/bootstrap.min.css" rel="stylesheet">
	<link href="public/css/bootstrap-table.css" rel="stylesheet">
	<link href="public/css/bootstrap-select.css" rel="stylesheet">
	<link href="public/css/jquery-ui-1.9.2.custom.css" rel="stylesheet" type="text/css" media="screen"  />
	<link href="public/css/long_common.css" rel="stylesheet"  media="all">
	<link href="public/draw/style/app.css" rel="stylesheet" >
	<link href="css/soda_common.css" rel="stylesheet" >
</head>

<body>
	<!--前台公共头部-->
	<div class="top">
		<div class="main_nav1">
			<div class="container">
				<a href="#" class="logo"><img src="public/image/navLogo.svg"/></a>
				<ul class="main_nav1_left">
					<li id="main"><a href="main.html">首页</a></li>
					<li id="sodaIndex"><a href="sodaIndex.html">云中漫步</a></li>
					<li id="frontierResearch"><a href="frontierResearch.html" >前沿方案</a></li>
					<li id="marketActive"><a href="marketActive.html">市场活动</a></li>	
				</ul>
				<div class="form-group searchNews" id="search_news">
					<span class="col-sm-2 control-label"><img src="public/image/navSearch.svg"/></span>
					<div class="col-sm-10">
						<input type="text" class="form-control" id="search_news_input">
					</div>
				</div>
				<ul class="main_nav1_right">
					<li id="searchIcon"><a href="#"><img src="public/image/navSearch.svg" alt="搜索" /></a></li>
					<li><a href="#"><img src="public/image/navEmail.svg" alt="通知" /></a></li>
					<li><a href="personalCenter.html"><img src="public/image/navUser.svg" alt="用户" /></a></li>
				</ul>
			</div>
		</div>
		<div class="main_nav2">
			<div class="container">
				<ul class="main_nav2_left">
					<li class="nav2_list1" style="width: 90px;">
						<a href="#" class="active">流程方案<img src="public/image/navDown.svg" alt=""></a>
						<ul class="">
							<li><a href="">DNA流程方案</a></li>
							<li><a href="">RNA流程方案</a></li>
							<li><a href="">医学流程方案</a></li>
						</ul>				
					</li>
					<li class="nav2_list2" style="width: 73px;">
						<a href="#">小工具<img src="public/image/navDown.svg" alt=""></a>
						<ul class="">
							<li><a href="">基本绘图</a></li>
							<li><a href="">流程绘图</a></li>
							<li><a href="">高级绘图</a></li>
							<li><a href="">表格处理</a></li>
							<li><a href="">计算统计</a></li>
						</ul>
					</li>
					<li class=""><a href="myProject.html">我的项目</a></li>
					<li class=""><a href="#">我的目录</a></li>
					<li class=""><a href="recycle.html">回收站</a></li>
				</ul>
				<div class="form-group">
					<div class="col-sm-10">
						<input type="text" class="form-control" placeholder="搜索想要使用的流程或小工具" id="search_flowapp">
					</div>
					<button class="col-sm-2 btn btn_blue" id="search_button">搜索</button>				
				</div>
			</div>
		</div>	
	<div class="nav_line"></div>
		<div class="main_nav3" style="box-shadow:-2px 3px 9px 0px #ccc;">
			<div class="container">
				<ul class="main_nav3_left_report">
					<li><span id="showReport"><a >查看报告</a></span></li>
					<li ><span id="downloadReport"><a >下载报告</a></span></li>
					<!--云超，下载报告的链接-->
					<li><span ><a id="taskRerun"  href="#">重跑一次</a></span></li>
					<li><span style="background: #13438b;"><a id="deepBtn" style="color: #fff;" href="#">深度挖掘</a></span></li>
				</ul>
				<ul class="main_nav3_right_report">
					<li  class="report_success"><span id="taskStatus"  class="btn btn-primary"><a href="#">任务运行中</a></span></li>
	
								<!--<li class="report_running"><span><a href="#">任务运行中</a></span></li>
								<li class="report_end"><span><a href="#">任务已终止</a></span></li>
							-->
					<li id="refresh">
						<a href="#"><img src="img/refresh.svg" alt="刷新" /></a>
					</li>
					<li id="stop">
						<a href="#"><img src="img/stop.svg" alt="停止" /></a>
					</li>
					<li id="delete">
						<a href="#"><img src="img/delete.svg" alt="删除" /></a>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<!--/前台公共头部-->
	 <div class="center_box" style="float:left;width:100%;margin-top: 145px;">
        <div class="myTab" > 
        	<div class="tabs" style="margin-left: 20px;float: none;width: 1185px;margin: 0 auto;">
				<ul class="nav">
					<li style="width: 160px;"><a href="#file" data-toggle="tab">KEGG通路散点图</a></li>
					<li style="width: 80px;"><span style="display: inline-block;width: 35px;height: 35px; background: url(img/bg_01.png);font-size: 25px;">3</span></li>
					<li style="width: 160px;"><a href="#show" data-toggle="tab">差异基因富集注释</a></li>
					<li style="width: 80px;"><span style="display: inline-block;width: 35px;height: 35px; background: url(img/bg_01.png);font-size: 25px;">2</span></li>
					<li class="active"  style="width: 160px;" ><a href="#direction" data-toggle="tab">差异基因筛选</a></li>
					<li style="width: 80px;"><span style="display: inline-block;width: 35px;height: 35px; background: url(img/bg_01.png);font-size: 25px;">1</span></li>
				</ul>
			</div>	
        </div>       
        <div class="myTab"  style="margin-bottom: 20px;background: #fff;">
        	<div style="width: 1200px;margin: 0 auto;height: 100%;">
				<div class="tabs" style="margin-left: 10px;text-align: left;line-height: 88px;font-size: 15px;color: #656565;">
					差异基因筛选参数设置
				</div>	
				<div class="tabs" style="margin-left: 20px;">
					<ul class="nav" id="appTabRight">
						<li ><a href="#" data-toggle="tab">使用说明</a></li>	
						<li ><a href="#show" data-toggle="tab">统计结果</a></li>
						<li><a href="#" data-toggle="tab">差异基因列表</a></li>
						<li class="active" ><a href="#" data-toggle="tab">火山图</a></li>
					</ul>
				</div>	
			</div>	
		</div>
        <div id="myTabContent" class="change_box">
			<div class="tab-content input_l">
				<div class="tab-pane in active" id="set">		
					<div class="panel  panel-default">				
						<div class="panel-body" style="height: 439px;">
							<form id="parameter">
								<!--输入文件-->
								<div class="part">
									<div class="input_a_l titleNameLeft">输出文件:</div>
									<div class="input_a_m" style="width: 330px;">
										<input v-model="input" type="text" class="form-control" id="input" name="input" placeholder="">
									</div>
									<div class="input_a_r">
										<a onclick="openUrl('#input','file')">
											<span class="glyphicon glyphicon-folder-open" style="font-size:20px; top: 5px; cursor:pointer;"></span>
										</a>
									</div>
								</div>		
								<div class="line"></div>
								<div class="part">
									<div class="input_a_l titleNameLeft">筛选软件:</div>
									<div class="input_b_3" style="width: 330px;float: left;">
										<select id="colorProject"  name="colorProject" class="selectpicker select_width" autocomplete="off" >
											<option value="project1">DESeq2</option>
											<option value="project2">DESeq</option>
											<option value="project3">edgeR</option>
											<option value="project4">DEGseq</option>
										</select>
									</div>									
								</div>
								<div class="part">
									<div class="input_a_l titleNameLeft">p值类型:</div>
									<div class="input_b_3" style="width: 330px;float: left;">
										<select id="colorProject"  name="colorProject" class="selectpicker select_width" autocomplete="off" >
											<option value="padj">padj</option>
											<option value="pval">pval</option>
										</select>
									</div>									
								</div>
								<div class="part">
									<div class="input_a_l titleNameLeft">p值大小:</div>
									<div class="input_b_3" style="width: 330px;float: left;">
										<select id="colorProject"  name="colorProject" class="selectpicker select_width" autocomplete="off" >
											<option value="padj">padj</option>
											<option value="pval">pval</option>
										</select>
									</div>									
								</div>
								<div class="line"></div>
								<div class="part">
									<div class="input_a_l titleNameLeft">差异比较分组</div>
									<div class="panel panel-default" style="padding:0px;">
										<!--<div class="panel-heading">
											<h4><span class="glyphicon glyphicon-edit"></span> 差异比较分组</h4>
										</div>-->
										<div class="panel-body" style="padding: 15px 0px 15px 20px !important;">
											<div style="margin-bottom: 55px;">
												<div style="float:left;width:24%;">
													<div><label class='control-label'><b>样本名称：</b></label></div>
												</div>
												<div style="float:left;width:21%;margin-right: 20px;">
													<div>
														<button class="btn btn-default" data-target='#groupModal' data-toggle='modal' style="outline: none;">
															<span class="glyphicon glyphicon-plus">Group</span>
														</button><br />
													</div>
												</div>
												<div style="float:left;width:21%;margin-right: 20px;">
													<div>
														<button class="btn btn-default" data-target='#compareModal' data-toggle='modal'style="outline: none;">
															<span class="glyphicon glyphicon-plus">Compare</span>
														</button>
													</div>   
												</div>
												<div style="float:left;width:21%;margin-right: 20px;">
													<div>
														<button class="btn btn-default"  data-target='#vennModal' data-toggle='modal' style="outline: none;">
															<span class="glyphicon glyphicon-plus">Venn</span>
														</button>
													</div>
												</div>
											</div>
											<div style="width:100%;">																				
												<div style="float:left;width:24%;margin-right: 20px;">
													<div id="sampleWrap">
														<ol id="sampleNames" class="list-group sampleNames ui-helper-reset ui-helper-clearfix" style="height: 100%;"></ol>
													</div>
												</div>
												<div id='groupList' style="float:left;width:21%;margin-right:20px;"></div>
												<div id='compareList' style="float:left;width:21%;margin-right:20px;"></div>
												<div id='vennList' style="float:left;width:21%"></div>																					
											</div>
										</div>
									</div>
								</div>
							</form>
						</div>
						<div class="panel-footer" style="height: 51px;">
							<button id="submit_paras" type="button" class="btn btn-success">开始绘图</button>
						</div>
					</div>
				</div>
				<div class="tab-pane" id="file">
					<div class="panel panel-default">
						<div class="panel-body" style="padding: 0;">
							<table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th v-for="item in fileData.content[0]">{{item}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(item,index) in fileData.content" v-if="index!=0">
                                        <td v-for="item1 in item">{{item1 }}</td>
                                    </tr>
                                </tbody>
                            </table>
						</div>
					</div>
				</div>
			</div>
	
			<!-- 绘图展示 -->
			<div class="tab-content input_r">
				<div class="tab-pane in active" id="show">
					<div class="panel panel-default">
						<div class="panel-body">
							<div id="main" style="width: 560px;height: 420px;"></div>
						</div>
					</div>
				</div>
	
			<!-- 使用说明 -->
				<div class="tab-pane" id="direction">
					<div class="panel panel-default">
						<div class="panel-body">
							<p>描述：</p>
							<p class="indent">
							对提供的各样本中，各基因的表达量，按log（x+1）转换后，绘制小提琴图（https://en.wikipedia.org/wiki/Violin_plot）。用于展示各样本基因整体表达量分布情况。
							</p>
							<p>参数：</p>
							<pre>
								--input	  输入文件名。例如：fpkm.txt
								--output  输出文件名。后缀为.png时，输出png图片；后缀为.pdf时，输出pdf图片。例如：violin.png
								--ylab	  y坐标轴标题，默认为：log(RPKM+1)。例如：log(TPM+1)
								--title	  图标题，默认为：RPKM distribution。例如：TPM distribution	
							</pre>
							<p>输入：</p>
							<div class="indent">基因表达量文件，第一列为geneID，其他列为各样本中基因表达量值（FPKM，RPKM或TPM）。</div>
							<div class="img_box">
								<img src="public/draw/imgs/bg.jpg" alt="">
							</div>
							<p>输出：</p>
							<div class="indent">后缀为.png时，输出png图片；后缀为.pdf时，输出pdf图片。</div>
						</div>
					</div>
				</div>
			</div>
		
    	</div>
        
	<!-- 标签切换 -->
	
	
	<!-- 添加选择目录的模态框 -->
	<div class="modal fade" id="selectUrl" tabindex="-1" aria-labelledby="选择路径" aria-hidden="true">

		<div class="modal-dialog" style="top:50px; width:800px;">
			<div class="modal-content ">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
						&times;
					</button>
					<h4 class="modal-title">路径</h4>
					<div class="input-group">
						<input type="text" class="form-control" id="inputUrl">
						<span class="input-group-btn">
							<button class="btn btn-default glyphicon glyphicon-arrow-left" id="back" type="button" style="top: 0px;"></button>
							<button class="btn btn-default glyphicon glyphicon-arrow-right" id="search" type="button" style="top: 0px;"></button>
						</span>
					</div>
				</div>
				<!-- -----------------------------------------------------------data-single-select="true"------------------------ -->
				<div class="modal-body" style="text-align:center; ">
					<table data-toggle="table" data-url="json/jobUrl.json" data-minimum-count-columns="2" data-id-field="id" data-show-footer="false"
						data-height="300" data-sort-name="id" data-click-to-select="true"  id="urlTable"
						style="bottom:20px;">

						<thead>
							<tr>
								<th data-field="state" data-checkbox="true"></th>
								<th data-field="icon" data-formatter="addIcon"></th>
								<th data-field="name" data-align="left" data-sortable="true">name</th>
								<th data-field="type" data-align="center" data-sortable="true">attribute</th>
								<th data-field="inodeNum" data-align="center" data-visible="false" data-sortable="true">inodeNum</th>
								<th data-field="size" data-align="center" data-sortable="true">size</th>
								<th data-field="owner" data-align="center" data-sortable="true">owner</th>
								<th data-field="group" data-align="center">group</th>
								<th data-field="mtime" data-align="center" data-sortable="true">time</th>
							</tr>
						</thead>
					</table>
				</div>
				<!-- ----------------------------------------------------------------------------------- -->
				<div class="modal-footer">
					<button type="button" id="selected" class="btn btn-primary">
					选择
					</button>
					<button type="button" id="cancel" class="btn btn-default" data-dismiss="modal">
					关闭
					</button>

				</div>
			</div>
		</div>

	</div>

	<div id="footer_style">
		<footer class="footerstyle">
			<p>版权所有 © 2016 京ICP备15033925号</p>
			<p>北京拓美科基因科技有限公司</p>
		</footer>
	</div>
	<script src="public/js/jquery-1.11.2.min.js"></script>
	<script src="public/js/bootstrap.min.js"></script>
	<script src="public/js/bootstrap-table.js"></script>
	<script src="public/js/bootstrap-select.js"></script>
	<script src="public/js/jquery-ui-1.9.2.custom.min.js" type="text/javascript"></script>
	<script src="public/js/jquery.blockUI.js" type="text/javascript"></script>
	<script src="public/js/long_common.js"></script>
	<script src="js/go.js"></script>
	<script src="js/common.js"></script>	
	<script>
	$(function(){
		//波波，这是删除，终止和重跑的地址
    var delete_url = "";
    var stop_url = "";
	var rerun_url = "";

//与后台交互时冻结
	$(document).ajaxStart($.blockUI).ajaxStop($.unblockUI);

//------按钮们--------
//刷新
	$("#refresh").click(function(){
		window.location.reload();
    });
//终止
	$("#stop").click(function(){
		var r=confirm("您确定要终止该任务吗？"); 
		if(r==true){
			 var id = $("#taskId").val();
			 $.ajax({
				    url:stop_url,  
				    type:'get',
				    data:{id:id},
				    dataType: "json",
				    success:function(data) {
				    	if(data['status']=='ERROR'){    //请求成功但没有执行成功
				    		alert(data['data']);
				    	}else{
							alert("任务终止成功！");
							$(this).find("img").attr("src","img/start.svg") 
				    	};
				     },    
				     error : function(XMLHttpRequest) {
				       alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText); 
				     }
				});  
		  };
    });    
//删除
	$("#delete").click(function(){
		var r=confirm("您确定要删除该任务吗？");
		if(r==true){

			 var id = $("#taskId").val();
			 $.ajax({
				    url:delete_url,  
				    type:'post',
				    data:{id:id},
				    dataType: "json",
				    success:function(data) {
				    	if(data['status']=='ERROR'){    //请求成功但没有执行成功
				    		alert(data['data']);
				    	}else{
							alert("删除成功！");	
				    	};
				     },    
				     error : function(XMLHttpRequest) {
				       alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);    
				     }
				});  
		  };
    });
    
    $(".main_nav3_left_report li").click(function(){
    	$(this).children("span").css("background",'#13438B').children("a").css("color","#fff");
    	$(this).siblings("li").children("span").css("background",'#fff').children("a").css("color","#777");
    })
	//rerun
	$("#taskRerun").click(function(){
		$(this).parent("span").css("background","#13438B").children("a").css("color","#fff");
		var r=confirm("您确定要rerun该任务吗？");
		if (r==true)
			{
				var id = $("#taskId").val();
				$.ajax({
					url:rerun_url,    //甄伟波，rerun的地址  
					type:'get',
					data:{id:id},
					dataType: "json",
					success:function(data) {
						if(data['status']=='ERROR'){    //请求成功但没有执行成功
							alert(data['data']);
						}else{
							alert("rerun成功！");
							$("#taskRerun").parent("span").css("background","#fff").children("a").css("color","#777");
						}
					},    
					error : function(XMLHttpRequest) {
						alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText); 
						$("#taskRerun").parent("span").css("background","#fff").children("a").css("color","#777");
					}
				});  
			};
	});
	
});

//页面加载完成之后，填充数据
$(document).ready(function(e) {
    getTaskData("json/taskDetail.1.json");
	
});
function openSftp(user,ip,port, eid){
	window.open('sftp://'+user+'@'+ip+':'+port+$("#"+eid).text());
}
	
function stopTask(taskid){
	if (typeof(taskStatus)=='undefined' || taskStatus == 'finished' || taskStatus =='failed' ){
		return false;
	}
	
	if(!confirm("您确定要终止任务吗？")){
		return false;
	}
	
	$.ajax({
		url:"__MODULE__/Task/stopTasks",
		type:'get',
		data:{id:taskid},
		dataType: "json",
		success:function(data){
			if(data['status']=='SUCCESS'){    
	    		$("#taskStatus").removeClass('btn-primary').addClass("btn-warning").text("任务已终止");
	    	}
			alert(data['data']);
			window.location.reload();
		},
		error : function(XMLHttpRequest) {
	       	alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);   
	    }
	});
}

//function getTaskData(url){
//	 $.ajax({
//			url:url,  
//			type:'get',
//			dataType: "json",
//			success:function(data) {
//				if(data['status']=='ERROR'){    //请求成功但没有执行成功
//					alert(data['data']);
//				}else{
//					
//					for(var key in data){
//						if(key == "samples"){   
//							//根据样本名填入table
//							var dataJson = [];   //用来存放填写样本表格的数据
//							var arr = data[key].split(",");
//
//							if(data["taskSeqType"] == "PE"){    //判断是双端   （注意：必须是PE）
//								for(var i=0;i<arr.length;i++){
//									var one = {};
//									one["sample"]=arr[i];
//									one["fq"]= arr[i]+"_1.fq.gz"
//									
//									var two = {}
//									two["sample"]=arr[i];
//									two["fq"]= arr[i]+"_2.fq.gz"
//								//	console.log(two)
//									dataJson.push(one);
//									dataJson.push(two);
//								};
//								
//							}
//							else{								//不是双端
//								for(var i=0;i<arr.length;i++){
//									var one = {};
//									one["sample"]=arr[i];
//									one["fq"]= arr[i]+".fq.gz"
//									dataJson.push(one);
//								};	
//							};
//
//							$('#sampleTable').bootstrapTable('load',dataJson);   //载入数据
//							
//							
//						}
//						
//						else if(key == "unselectNode"){
//							var unselectNode = data.unselectNode.split(",");
//							for(var i=0;i<unselectNode.length;i++){
//								if(!diagram.findNodeForKey(unselectNode[i])){
//									continue;
//								}
//								diagram.findNodeForKey(unselectNode[i]).elt(0).fill=unselectColor;	//未选中模块变成灰色
//								nodeStatus[unselectNode[i]] = 0;
//							};
//
//							var runMod = data.runMod.split(",");
//							for(var i=0;i<runMod.length;i++){
//								if(!diagram.findNodeForKey(runMod[i])){
//									continue;
//								}
//								diagram.findNodeForKey(runMod[i]).elt(0).fill=runningColor;	//运行中模块变成绿色
//							};
//							var failedMod = data.failedMod.split(",");
//							for(var i=0;i<failedMod.length;i++){
//								if(!diagram.findNodeForKey(failedMod[i])){
//									continue;
//								}
//								diagram.findNodeForKey(failedMod[i]).elt(0).fill=failedColor;	//失败模块变成红色
//							};
//							selectedNode(); 
//
//							var nodePara = data.nodePara   //填充模块参数
//							for(var i=0;i<nodePara.length;i++){
//								$("#"+nodePara[i].name).val(nodePara[i].value)
//								};
//							 }
//						else if(key == "modStatus"){  //填充任务状态table
//							$('#modStatusTable').bootstrapTable('load',data[key]);
//							}
////							波波，这是之前的判断状态的，现在暂时去掉了
//						else if(key == "status"){
//							taskStatus = data.status;
//							if(data.status == "finished"){
//								$("#showReport").attr("onclick","window.open('__MODULE__/Report/showReport/id/{$id}')");
//								$("#downloadReport").attr("onclick","window.open('__MODULE__/Report/downReport/id/{$id}')");
//								$("#taskStatus").removeClass("btn-success");
//								$("#taskStatus").addClass("btn-primary").text('任务已完成');								
//							}else if(data.status == "failed"){
//								$("#taskStatus").addClass("btn-warning").text('任务已终止');
//								$("#showReport").css("background","#ccc");
//								$("#downloadReport").css("background","#ccc");
//								$("#taskReport h4").after('<p>任务终止，报告未生成。</p>');
//							}
//							else {
//									$("#taskStatus").addClass("btn-success").text('任务运行中');
//									$("#showReport").css("background","#ccc");
//									$("#downloadReport").css("background","#ccc");
//									$("#taskReport h4").after('<p>报告尚未生成，请耐心等待</p>');
//								}
//							}
//							
//						else{
//								$("#"+key).val(data[key])
//							};
//					};
//				};
//			 },    
//			 error : function(XMLHttpRequest) {
//			   alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);    
//			 }
//		}); 
//	};


//任务的状态

function taskState(State) {
	
    if ( State == 'done'){
			return  '<button class="btn btn-primary btn-xs" style="width:100px;">完成</button>';
		}else	if ( State == 'failed'){
			return '<button class="btn btn-warning btn-xs" style="width:100px;">中止</button>';
		}else if (State == 'ready'){
			return '<button class="btn  btn-xs" style="width:100px;">就绪/重运行</button>';
		}else if (State == 'pending'){
			return '<button class="btn btn-xs" style="width:100px;">等待中</button>';
		}
		else{
			return '<button class="btn btn-success btn-xs" style="width:100px;">运行中</button>';
		}
};	
	
</script>


</body>

</html>