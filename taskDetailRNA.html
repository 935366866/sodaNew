<!DOCTYPE html>
<html>
<head>
	<title>查看任务</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="content-type" content="text/html" ; charset="utf-8">
	<link href="public/css/reset.css" rel="stylesheet" />
	<link href="public/css/bootstrap.min.css" rel="stylesheet">
	<link href="public/css/bootstrap-table.css" rel="stylesheet">
	<link href="public/css/bootstrap-select.css" rel="stylesheet">
	<link href="public/css/jquery-ui-1.9.2.custom.css" rel="stylesheet" type="text/css" media="screen"  />
	<link href="public/css/long_common.css" rel="stylesheet"  media="all">
	<link href="css/soda_common.css" rel="stylesheet" >
	<link rel="stylesheet" href="css/common.css">	
</head>

<body style="background-color: rgb(248,248,248);">
	<!--前台公共头部-->
	<div class="top">
		<div class="main_nav1">
			<div class="container">
				<a href="#" class="logo"><img src="public/image/navLogo.svg"/></a>
				<ul class="main_nav1_left">
					<li id="main"><a href="main.html">首页</a></li>
					<li id="sodaIndex"><a href="sodaIndex.html">云中漫步</a></li>
					<li id="frontierResearch"><a href="frontierResearch.html" >前沿方案</a></li>
					<li id="marketActive"><a href="marketActive.html">市场活动</a></li>	
				</ul>
				<div class="form-group searchNews" id="search_news">
					<span class="col-sm-2 control-label"><img src="public/image/navSearch.svg"/></span>
					<div class="col-sm-10">
						<input type="text" class="form-control" id="search_news_input">
					</div>
				</div>
				<ul class="main_nav1_right">
					<li id="searchIcon"><a href="#"><img src="public/image/navSearch.svg" alt="搜索" /></a></li>
					<li><a href="#"><img src="public/image/navEmail.svg" alt="通知" /></a></li>
					<li><a href="personalCenter.html"><img src="public/image/navUser.svg" alt="用户" /></a></li>
				</ul>
			</div>
		</div>
		<div class="main_nav2">
			<div class="container">
				<ul class="main_nav2_left">
					<li class="nav2_list1" style="width: 90px;">
						<a href="#" class="active">流程方案<img src="public/image/navDown.svg" alt=""></a>
						<ul class="">
							<li><a href="">DNA流程方案</a></li>
							<li><a href="">RNA流程方案</a></li>
							<li><a href="">医学流程方案</a></li>
						</ul>				
					</li>
					<li class="nav2_list2" style="width: 73px;">
						<a href="#">小工具<img src="public/image/navDown.svg" alt=""></a>
						<ul class="">
							<li><a href="">基本绘图</a></li>
							<li><a href="">流程绘图</a></li>
							<li><a href="">高级绘图</a></li>
							<li><a href="">表格处理</a></li>
							<li><a href="">计算统计</a></li>
						</ul>
					</li>
					<li class=""><a href="myProject.html">我的项目</a></li>
					<li class=""><a href="#">我的目录</a></li>
					<li class=""><a href="recycle.html">回收站</a></li>
				</ul>
				<div class="form-group">
					<div class="col-sm-10">
						<input type="text" class="form-control" placeholder="搜索想要使用的流程或小工具" id="search_flowapp">
					</div>
					<button class="col-sm-2 btn btn_blue" id="search_button">搜索</button>				
				</div>
			</div>
		</div>	
	<div class="nav_line"></div>
		<div class="main_nav3" style="box-shadow:-2px 3px 9px 0px #ccc;">
			<div class="container">
				<ul class="main_nav3_left_report">
					<li><span id="showReport"><a >查看报告</a></span></li>
					<li ><span id="downloadReport"><a >下载报告</a></span></li>
					<!--云超，下载报告的链接-->
					<li><span ><a id="taskRerun"  href="#">重跑一次</a></span></li>
					<li><span ><a id="deepBtn" style="color: #777;" href="#">深度挖掘</a></span></li>
				</ul>
				<ul class="main_nav3_right_report">
					<li  class="report_success"><span id="taskStatus"  class="btn btn-success"><a href="#">任务运行中</a></span></li>
	
								<!--<li class="report_running"><span><a href="#">任务运行中</a></span></li>
								<li class="report_end"><span><a href="#">任务已终止</a></span></li>
							-->
					<li id="refresh">
						<a href="#"><img src="img/refresh.svg" alt="刷新" /></a>
					</li>
					<li id="stop">
						<a href="#"><img src="img/stop.svg" alt="停止" /></a>
					</li>
					<li id="delete">
						<a href="#"><img src="img/delete.svg" alt="删除" /></a>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<!--/前台公共头部-->

	<input style="display:none;" id="taskId" />
	<!--该任务的ID-->
	
	<div style="float:left;width:100%;margin-bottom: 30px;padding-top: 160px;">
			<div class="change_box" style="padding-left: 0px; padding-right:0px;padding-bottom:50px;">
				<!--
					<button id="changeModule" class="btn btn-primary">切换到模块</button>
				-->
					<!--第一部分 流程图 -->
					<div class="part_box" style=" padding-top:11px; ">

						<div class="task_form_height" >
							<label class="task_label" style="width:100%;"><span class="colorRNA">1</span>有参转录组分析流程V1.0</label>
						</div>

						<!--流程图的div-->
						<div id="myDiagramDiv">
						</div>
								
						<!--运行状态-->
						<div class="task_form_height">
							<div class="task_label">&nbsp;</div>
							
							<div id="modStatus">
								<div>
									<div style="padding: 0px;">
										<!-- ================================================================== -->

										<table data-toggle="table" data-height="200" data-show-footer="false" data-sort-name="id" id="modStatusTable">
											<thead>
												<tr>
													<th data-field="flow_mod" data-sortable="true">模块名称</th>
													<th data-field="task_name" data-sortable="true">程序名称</th>
													<th data-field="status" data-sortable="true" data-align="center" data-formatter="taskState">状态</th>
													<th data-field="submit_time" data-sortable="true" data-align="center">任务提交时间</th>
													<th data-field="done_time" data-sortable="true" data-align="center">任务结束时间</th>
													<th data-field="consume_time" data-sortable="true" data-align="center">时长</th>
												</tr>
											</thead>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!--第二部分表格的填写-->
					<div class="part_box">
						<form class="form-horizontal" id="creatTask" role="form" style="margin-top: 30px;" action="newTask" method="post" onsubmit="return submitForm(this)">
							<input type='hidden' id='task_type' name='task_type' value='ref' />
							<input type='hidden' id='id' name="id" value="{$id} "></input>
							
							<div class=" task_form_height">						
								<label class="task_label"><span class="colorRNA">2</span>任务名称</label>
								<div class="task_box" >
									<input type="text" class="form-control" required id="task_name" name="task_name" readonly>
								</div>
							</div>

							<div class="task_form_height">
								<label class="task_label"><span class="colorRNA">3</span>所属项目</label>
								<div class="task_box">
									<input type="text" class="form-control" id="project_name" name="project_name" readonly>
								</div>

							</div>

							<div class="task_form_height">
								<label class="task_label"><span class="colorRNA">4</span>任务目录</label>
								<div class="task_box" >
									<input type="url" class="form-control" id="dir_path" name="dir_path" readonly>
								</div>
							</div>


							<div class="task_form_height">
								<label class="task_label"><span class="colorRNA">5</span>物种名称</label>

								<div class="task_box">
									<input type="url" class="form-control" id="species" name="species" readonly>
								</div>
							</div>

							<div class="task_form_height">
								<label class="task_label"><span class="colorRNA">6</span>链特异性文库</label>

								<div class="task_box">
									<input type="url" class="form-control" id="is_sslib" name="is_sslib" readonly>
								</div>
							</div>

							<div class="task_form_height">
								<label class="task_label"><span class="colorRNA">7</span>测序类型</label>
								
								<div class="task_box">
									<input type="url" class="form-control" id="seq_type" name="seq_type" readonly>
								</div>
							</div>

							<!--数据目录-->
							<div class="task_form_height">
								<label class="task_label"><span class="colorRNA">8</span>数据目录</label>
								<div class="task_box" >
									<input type="url" class="form-control " required id="data_dir" name="data_dir" readonly>
								</div>
							</div>

						</form>

					<!--第二部分 选择sample的表格 -->
					<div class="task_form_height">
					<div class="task_label">&nbsp;</div>
					<div class="task_box">
						<table  id="sampleTable">
							<!--<thead>
								<tr>
									<th data-field="sample" data-align="left" data-sortable="true">样本名称</th>
									<th data-field="fq" data-align="center" data-sortable="true">FastQ文件 </th>
								</tr>
							</thead>-->
						</table>
					</div>
					</div>

					</div>
					
					<!-- ---------------------------------------------------------------------- -->
					
					<!--第五部分 样本分组、比较、维恩图 -->
					<!-- 样本分组、比较、维恩图 -->
					<div class="part_box">
						<!--带星 分组比较标题-->
						<div class="task_form_height" id="comGroup">
							<label class="task_label"><span class="colorRNA">9</span>分组比较</label>
						<!--拖拽分组的还原-->
					
							<div class="panel panel-default sample_part">
								<div class="panel-heading" style="height: 40px">
									<p class="col-sm-3" style="text-align: center;"><strong>样本名称</strong></p>
									<p class="col-sm-3" style="text-align: center;"><strong>Group</strong></p>
									<p class="col-sm-3" style="text-align: center;"><strong>Compare</strong></p>
									<p class="col-sm-3" style="text-align: center;"><strong>Venn</strong></p>
								</div>
								<div class="panel-body">
									<!--样本名称-->
									<div id="samplesSelected" class="col-sm-3"></div>
									<!--Group-->
									<div id="Group" class="col-sm-3"></div>
									<!--Compare-->
									<div id="Compare" class="col-sm-3"></div>
									<!--Venn-->
									<div id="Venn" class="col-sm-3"></div>
								</div>
							</div>	
						</div>									
					</div>
					<!--第四部分 模块参数设置-->

					<div class="part_box">
						<div class="task_form_height" id="paraTitle">
							<label class="task_label"><span class="colorRNA">10</span>模块参数设置</label>
							<!--点击展开参数-->
							<div class="panel-group params_part" id="parasPanel"></div>							
						</div>
					</div>
					<!-- ------------------------------参数设置结束-------------------------------- -->
			</div>
	</div>
	<!--页脚-->
	<div id="footer_style">
		<footer class="footerstyle">
			<p>版权所有 © 2016 京ICP备15033925号</p>
			<p>北京拓美科基因科技有限公司</p>
		</footer>
	</div>
	<script src="public/js/jquery-1.11.2.min.js"></script>
	<script src="public/js/bootstrap.min.js"></script>
	<script src="public/js/bootstrap-table.js"></script>
	<script src="public/js/bootstrap-select.js"></script>
	<script src="public/js/jquery-ui-1.9.2.custom.min.js" type="text/javascript"></script>
	<script src="public/js/jquery.blockUI.js" type="text/javascript"></script>
	<script src="public/js/long_common.js"></script>
	<script src="js/go.js"></script>
	<script src="js/common.js"></script>		
	<script>
	$(function(){
		//波波，这是删除，终止和重跑的地址
    var delete_url = "";
    var stop_url = "";
	var rerun_url = "";

//与后台交互时冻结
	$(document).ajaxStart($.blockUI).ajaxStop($.unblockUI);

//------按钮们--------
//刷新
	$("#refresh").click(function(){
		window.location.reload();
    });
//终止
	$("#stop").click(function(){
		var r=confirm("您确定要终止该任务吗？");
		if(r==true){
			 var id = $("#taskId").val();
			 $.ajax({
				    url:stop_url,  
				    type:'post',
				    data:{id:id},
				    dataType: "json",
				    success:function(data) {
				    	if(data['status']=='ERROR'){    //请求成功但没有执行成功
				    		alert(data['data']);
				    	}else{
							alert("任务终止成功！");	
							$(this).find("img").attr("src","img/start.svg") 
				    	};
				     },    
				     error : function(XMLHttpRequest) {
				       alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);    
				     }
				});  
		  };
    });    
//删除
	$("#delete").click(function(){
		var r=confirm("您确定要删除该任务吗？");
		if(r==true){

			 var id = $("#taskId").val();
			 $.ajax({
				    url:delete_url,  
				    type:'post',
				    data:{id:id},
				    dataType: "json",
				    success:function(data) {
				    	if(data['status']=='ERROR'){    //请求成功但没有执行成功
				    		alert(data['data']);
				    	}else{
							alert("删除成功！");	
				    	};
				     },    
				     error : function(XMLHttpRequest) {
				       alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);    
				     }
				});  
		  };
    });
    $(".main_nav3_left_report li").click(function(){
    	$(this).children("span").css("background",'#13438B').children("a").css("color","#fff");
    	$(this).siblings("li").children("span").css("background",'#fff').children("a").css("color","#777");
    })
    //深度挖掘
    $("#deepBtn").click(function(){
    	window.location.href= "deepExcavation.html";
    })
	//rerun
	$("#taskRerun").click(function(){
		$(this).parent("span").css("background","#13438B").children("a").css("color","#fff");
		var r=confirm("您确定要rerun该任务吗？");
		if (r==true)
			{
				var id = $("#taskId").val();
				$.ajax({
					url:rerun_url,    //甄伟波，rerun的地址  
					type:'post',
					data:{id:id},
					dataType: "json",
					success:function(data) {
						if(data['status']=='ERROR'){    //请求成功但没有执行成功
							alert(data['data']);
						}else{
							alert("rerun成功！");	
						}
						},    
						error : function(XMLHttpRequest) {
						alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);    
						}
				});  
			};
	});
	
});

//页面加载完成之后，填充数据
$(document).ready(function(e) {
    getTaskData("json/taskDetail.1.json");
	
});
function openSftp(user,ip,port, eid){
	window.open('sftp://'+user+'@'+ip+':'+port+$("#"+eid).text());
}
	
function stopTask(taskid){
	if (typeof(taskStatus)=='undefined' || taskStatus == 'finished' || taskStatus =='failed' ){
		return false;
	}
	
	if(!confirm("您确定要终止任务吗？")){
		return false;
	}
	
	$.ajax({
		url:"__MODULE__/Task/stopTasks",
		type:'post',
		data:{id:taskid},
		dataType: "json",
		success:function(data){
			if(data['status']=='SUCCESS'){    
	    		$("#taskStatus").removeClass('btn-primary').addClass("btn-warning").text("任务已终止");
	    	}
			alert(data['data']);
			window.location.reload();
		},
		error : function(XMLHttpRequest) {
	       	alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);   
	    }
	});
}

function getTaskData(url){
	 $.ajax({
			url:url,  
			type:'get',
			dataType: "json",
			success:function(data) {
				if(data['status']=='ERROR'){    //请求成功但没有执行成功
					alert(data['data']);
				}else{
					for(var key in data){
						if(key == "samples"){  
							window.sessionStorage.setItem("samples",data[key]);
							//根据样本名填入table
							var dataJson = [];   //用来存放填写样本表格的数据
							var arr = data[key].split(",");
							//样本分组比较，填入样本
							var arr = data[key].split(",");
							for(var i=0;i<arr.length;i++){
								$("#samplesSelected").append('<div class="samplesDIV"><span style="color:#FFF;">'+arr[i]+'</span></div>')
							};
						}else if(key == "sampleData"){
							var sampleData=data["sampleData"]
						  	var tableData=[];
							if(data["seq_type"] == "PE"){    //判断是双端   （注意：必须是PE）
								var options={
									toolbar:"#toolbar",
									clickToSelect:true,
									showFooter:false,
									classes:'table',
									height:"250",
									columns: [   
								        {align: "left", field: "sample", order: "asc",editable:{type:'text'}, title: "样本名称 "},
								        {align: "center", field: "fq1", order: "asc", title: "FastQ1文件 "},
								        {align: "center", field: "fq2", order: "asc", title: "FastQ2文件 "}
							      	]
								}
									
								$('#sampleTable').bootstrapTable(options);
								var option=$('#sampleTable').bootstrapTable("getOptions");
								option.columns=[{
									align: "left",
									field: "sample", 
									order: "asc",
									title: "样本名称"
								},{
									align: "center", field: "fq1", order: "asc", title: "FastQ1文件 "
								},{
									align: "center", field: "fq2", order: "asc", title: "FastQ2文件 "
								}];
								$('#sampleTable').bootstrapTable('destroy');
								$('#sampleTable').bootstrapTable(option);
						  		$('#sampleTable').bootstrapTable("resetView");
						  		for(var i=0;i<sampleData.length;i++){
						  			var row=sampleData[i];
						  			var tableRow={};
						  			for(var key in row){
						  				tableRow["sample"]=key;
						  				tableRow["fq1"]=row[key][0];
						  				tableRow["fq2"]=row[key][1];
						  			}
						  			tableData.push(tableRow)
						  		}

							}else{		//不是双端
									var options={
										toolbar:"#toolbar",
										clickToSelect:true,
										showFooter:false,
										classes:'table',
										height:"250",
										columns: [   
									        {align: "left", field: "sample", order: "asc",editable:{type:'text'}, title: "样本名称 "},
									        {align: "center", field: "fq1", order: "asc", title: "FastQ文件 "}
								      	]
									}
									
									$('#sampleTable').bootstrapTable(options);
									var option=$('#sampleTable').bootstrapTable("getOptions");
									option.columns=[{
										align: "left",
										field: "sample", 
										order: "asc",
										title: "样本名称"
									},{
										align: "center", field: "fq", order: "asc", title: "FastQ文件 "
									}];
									$('#sampleTable').bootstrapTable('destroy');
									$('#sampleTable').bootstrapTable(option);
							  		$('#sampleTable').bootstrapTable("resetView");
									for(var i=0;i<sampleData.length;i++){
							  			var row=sampleData[i];
							  			var tableRow={};
							  			for(var key in row){
							  				tableRow["sample"]=key;
							  				tableRow["fq"]=row[key][0];
							  			}
							  			tableData.push(tableRow)
							  		}
								};
	
								$('#sampleTable').bootstrapTable('load',tableData);   //载入数据
							
							}
						else if(key == "group_samples" || key == "compare_groups" || key=="venn_compares"){  //样本分组比较的其他信息填写
							if(data[key] == null || data[key] == 'null' ||data[key] == ''){
								data[key]=[];
							}else if(typeof(data[key])!='object'){
								data[key]= JSON.parse(data[key]);
							}
							
							if(key == "group_samples"){
								var group_samples = data["group_samples"];  //填入group信息
								if(group_samples == null || group_samples == 'null' ||data[key] == ''){
									data[key]=[];
								}
								var objTemp={}
								for(var group in group_samples){
									var str='';
									var arrTemp=[];
									for(var each=0;each<group_samples[group].length;each++){
										arrTemp.push(group_samples[group][each])
										 str += '<div class="samplesDIV"><span style="color:#FFF;">'+group_samples[group][each]+'</span></div>';
									};
									objTemp[group]=arrTemp;
									$("#Group").append('<div class="groupDIV"><span style="color:#FFF;">'+group+'</span>'+str+'</div>')
								};
								objTemp = JSON.stringify(objTemp);
								window.sessionStorage.setItem("groupSamples",objTemp);
							}
							
							if(key == "compare_groups"){
								var objTemp2={}
								var compare_groups = data["compare_groups"];  //填入compare信息
								for(var com in compare_groups){
									var str='';
									var arrTemp2=[];
									for(var each=0;each<compare_groups[com].length;each++){
										arrTemp2.push(compare_groups[com][each])
										 str += '<div class="samplesDIV"><span style="color:#FFF;">'+compare_groups[com][each]+'</span></div>';
									};
									objTemp2[com]=arrTemp2;
									$("#Compare").append('<div class="groupDIV"><span style="color:#FFF;">'+com+'</span>'+str+'</div>');
									};
									objTemp2 = JSON.stringify(objTemp2);
									window.sessionStorage.setItem("compareGroups",objTemp2);
							}
							
							if(key == "venn_compares"){
									var objTemp1={}
									var venn_compares = data["venn_compares"];  //填入compare信息
		
									for(var venn in venn_compares){
										var str='';
										var arrTemp1=[];
										for(var each=0;each<venn_compares[venn].length;each++){
											arrTemp1.push(venn_compares[venn][each]);
											 str += '<div class="samplesDIV"><span style="color:#FFF;">'+venn_compares[venn][each]+'</span></div>';
										};
										objTemp1[venn]=arrTemp1;
										$("#Venn").append('<div class="groupDIV"><span style="color:#FFF;">'+venn+'</span>'+str+'</div>');
									};
									objTemp1 = JSON.stringify(objTemp1);
									window.sessionStorage.setItem("vennCompares",objTemp1);
								}
								
							}
							
						else if(key == "unselectNode"){
							if(data.unselectNode.indexOf("DE")==-1){
								$("#comGroup").show();
								$("#paraTitle").show();
							}else{
								$("#comGroup").hide();	
								$("#paraTitle").hide();
							}
							var unselectNode = data.unselectNode.split(",");
							for(var i=0;i<unselectNode.length;i++){
								if(!diagram.findNodeForKey(unselectNode[i])){
									continue;
								}
								diagram.findNodeForKey(unselectNode[i]).elt(0).fill=unselectColor;	//未选中模块变成灰色
								nodeStatus[unselectNode[i]] = 0;
							};

							var runMod = data.runMod.split(",");
							for(var i=0;i<runMod.length;i++){
								if(!diagram.findNodeForKey(runMod[i])){
									continue;
								}
								diagram.findNodeForKey(runMod[i]).elt(0).fill=runningColor;	//运行中模块变成绿色
							};
							var failedMod = data.failedMod.split(",");
							for(var i=0;i<failedMod.length;i++){
								if(!diagram.findNodeForKey(failedMod[i])){
									continue;
								}
								diagram.findNodeForKey(failedMod[i]).elt(0).fill=failedColor;	//失败模块变成红色
							};
							selectedNode(); 

							var nodePara = data.nodePara   //填充模块参数
							for(var i=0;i<nodePara.length;i++){
								$("#"+nodePara[i].name).val(nodePara[i].value)
								};
							 }
						else if(key == "modStatus"){  //填充任务状态table
							var jsonData = JSON.stringify(data[key]);
							
							$('#modStatusTable').bootstrapTable('load',data[key]);
							}
//							 波波，这是之前的判断状态的，现在暂时去掉了
						else if(key == "status"){
							taskStatus = data.status;
							if(data.status == "finished"){
								$("#showReport").attr("onclick","window.open('__MODULE__/Report/showReport/id/{$id}')");
								$("#downloadReport").attr("onclick","window.open('__MODULE__/Report/downReport/id/{$id}')");
								$("#taskStatus").removeClass("btn-success");
								$("#taskStatus").addClass("btn-primary").text('任务已完成');								
							}else if(data.status == "failed"){
								$("#taskStatus").addClass("btn-warning").text('任务已终止');
								$("#showReport").css("background","#ccc");
								$("#downloadReport").css("background","#ccc");
								$("#taskReport h4").after('<p>任务终止，报告未生成。</p>');
							}
							else {
									$("#taskStatus").addClass("btn-success").text('任务运行中');
									$("#showReport").css("background","#ccc");
									$("#downloadReport").css("background","#ccc");
									$("#taskReport h4").after('<p>报告尚未生成，请耐心等待</p>');
								}
							}
							
						else{
								$("#"+key).val(data[key])
								window.sessionStorage.setItem("id",$("#dir_path").attr("id"));
								window.sessionStorage.setItem("dir_path",$("#dir_path").val());
							};
					};
				};
			 },   
			 error : function(XMLHttpRequest) {
			   alert(XMLHttpRequest.status +' '+ XMLHttpRequest.statusText);    
			 }
		}); 
	};


//任务的状态

function taskState(State) {
	
    if ( State == 'done'){
			return  '<button class="btn btn-primary btn-xs" style="width:100px;">完成</button>';
		}else	if ( State == 'failed'){
			return '<button class="btn btn-warning btn-xs" style="width:100px;">中止</button>';
		}else if (State == 'ready'){
			return '<button class="btn  btn-xs" style="width:100px;">就绪/重运行</button>';
		}else if (State == 'pending'){
			return '<button class="btn btn-xs" style="width:100px;">等待中</button>';
		}
		else{
			return '<button class="btn btn-success btn-xs" style="width:100px;">运行中</button>';
		}
};	
	
//判断是否是草稿，加载任务参数填写时option的值
var nodeStatus=
{
	'Basic_QC':1,
	'Alignment':1,
	'Advanced_QC':1,
	"SNP_INDEL":1,
	"Assemble":1,
	"AS":1,
	"DE":1,
	"PPI":1,
	"GO":1,
	"KEGG":1
};
//各种默认参数的url
var nodeParaUrl="__MODULE__/Task/getTaskInfo/id/{$id}";  // 节点参数的默认值的url
var samplesDataUrl = "__MODULE__/Data/remoteDirView"; //像后台发送目录的地址

//设置每个节点的状态
var selectColor="rgb(142,217,255)";
var unselectColor="lightgray";
var runningColor="rgb(68,157,68)";
var failedColor="rgb(255,0,0)"
var arrowColor="rgb(100,100,100)";
var nodeNameColor="rgb(255,255,255)";
var nodeBorderColor="rgb(167,167,167)";
$(function() {

	 var $ = go.GraphObject.make;  // for conciseness in defining templates
//---------------

diagram =
      $(go.Diagram, "myDiagramDiv",  // must name or refer to the DIV HTML element
        {
          initialContentAlignment: go.Spot.Center,
          allowDrop: false,  // must be true to accept drops from the Palette
 //         "LinkDrawn": showLinkLabel,  // this DiagramEvent listener is defined below
//          "LinkRelinked": showLinkLabel,
          "animationManager.duration": 800, // slightly longer than default (600ms) animation
          "undoManager.isEnabled": false  // enable undo & redo
        });

//----------------
	
//节点的样式
		diagram.nodeTemplate =
			$(go.Node, "Auto",
 
			  new go.Binding("location", "loc", go.Point.parse),
			  $(go.Shape, "RoundedRectangle", { fill: selectColor ,
			  									parameter1: 5,  // the corner has a large radius
			  									stroke:nodeBorderColor,
												
												},
												new go.Binding("fill", "color")
												),     
										
			  {
				  selectionAdornmentTemplate:
				  $(go.Adornment, "Auto",
					$(go.Shape, "RoundedRectangle",
					{ fill: null, stroke: selectColor, strokeWidth: 1 }),
					$(go.Placeholder)
				  )  // end Adornment
			  },
				
				
			  $(go.TextBlock,{ font: "bold 14px sans-serif",
							   stroke: nodeNameColor,
							   margin: 10 },
				new go.Binding("text", "key"))
			);

		
//连线的样式
	   diagram.linkTemplate =
		  $(go.Link,  // the whole link panel
			{ curve: go.Link.Bezier, reshapable: true },
			// don't need to save Link.points, so don't need TwoWay Binding on "points"
			new go.Binding("curviness", "curviness").makeTwoWay(),  // but save "curviness" automatically
			$(go.Shape,  // the link shape
			  { strokeWidth: 2 ,stroke:arrowColor }),
	//		  new go.Binding("stroke", "color"),
			$(go.Shape,  // the arrowhead
			  { toArrow: "standard", stroke: null, fill:arrowColor })
			
		  );  


		
  var nodeDataArray = [
		{key: "Basic_QC", loc:"0 0"},
		{key: "Alignment", loc:"-5 100"},
		{key: "Advanced_QC", loc:"150 100"},
		{key: "SNP_INDEL", loc:"160 200"},
		{key: "Assemble", loc:"0 200"},
		{key: "AS", loc:"-100 200"},
		{key: "DE", loc:"25 300"},
		{key: "PPI", loc:"-70 400"},
		{key: "GO", loc:"25 400"},
		{key: "KEGG", loc:"120 400"}
	  ];
  
  var linkDataArray = [
		{from: "Basic_QC", to:"Alignment", "curviness":0},
		{from: "Alignment", to:"Advanced_QC", "curviness":0},
		{from: "Advanced_QC", to:"SNP_INDEL", "curviness":0},
		{from: "Alignment", to:"Assemble", "curviness":0},
		{from: "Assemble", to: "AS", "curviness":0},
		{from: "Assemble", to: "DE", "curviness":0},
		{from: "DE", to: "PPI", "curviness":-20},
		{from: "DE", to: "GO", "curviness":0},
		{from: "DE", to: "KEGG", "curviness":20}
	  ];
 
	 diagram.model = new go.GraphLinksModel(nodeDataArray, linkDataArray);	
	 diagram.initialContentAlignment = go.Spot.Center; //整个图居中		
	});


//选定的模块参数
function selectedNode(){
	$("#parasPanel").html(""); //清空现有的参数
	for(var key in nodeStatus){
		//console.log(key)
		if (nodeStatus[key] == 1){
			//添加该模块的面板
			if(! defaultRefParams[key]){
				continue;
			}
			
			$("#parasPanel").append('<div class="panel panel-default"  id="' + key + '"><div class="panel-heading"><h4 class="panel-title"><a data-toggle="collapse" data-parent="#' + key + '" href="#' + key + '_panel_body">' + key + ' 参数设置</a></h4></div><div id="' + key + '_panel_body" class="panel-collapse collapse in"><div class="panel-body"><form class="form-horizontal" role="form"></form></div></div></div>');
			addPara(key); //添加面板中的参数

		};
	};
	
};
//在参数设置中 给node名字为key的模块 添加input或dropdown参数
function addPara(key){
				var data = defaultRefParams;
				items = data[key];   //找到参数中键为key的node项目
				if(typeof(items)=='undefined'){
					return false;
				}
					
				for (var i=0; i < items.length; i++){   //遍历其中的许多参数
				   //添加一个input框
						var name = items[i]["name"]
						var id = items[i]["id"]
						var value = items[i]["value"]
						var info = items[i]["illustration"]
						//添加input的代码
						$("#" + key + " form").append('<div class="form-group"><label class="col-sm-3 control-label">' + name + '</label><div class="col-sm-7"><input type="text"  class="form-control" readonly id="'+ id +'" name="'+ id +'" title="' + info + '"></div></div>');
				
				};					
	
	};
//与后台交互时冻结
//$(document).ajaxStart($.blockUI).ajaxStop($.unblockUI);
</script>


</body>

</html>